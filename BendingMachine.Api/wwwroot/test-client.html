<!DOCTYPE html>
<html>
<head>
    <title>CNC Machine SignalR Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .control-group { background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #dee2e6; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        input[type="number"] { padding: 5px; margin: 5px; width: 80px; }
        #messages { height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .message { margin: 2px 0; }
        .info { color: #0066cc; }
        .success { color: #009900; }
        .error { color: #cc0000; }
        .warning { color: #ff9900; }
        .data { color: #6600cc; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏭 CNC Profil Büküm Makinesi - SignalR Test Client</h1>
        
        <div id="connectionStatus" class="status disconnected">
            BAĞLANTI DURUMU: Bağlantı Kapalı
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>🔌 Bağlantı Kontrolü</h3>
                <button id="connectBtn" class="btn-primary" onclick="connect()">Bağlan</button>
                <button id="disconnectBtn" class="btn-danger" onclick="disconnect()">Bağlantıyı Kes</button>
            </div>

            <div class="control-group">
                <h3>📊 Durum Sorgula</h3>
                <button class="btn-success" onclick="requestMachineStatus()">Makine Durumu</button>
                <button class="btn-success" onclick="requestPistonStatus()">Piston Durumu</button>
            </div>

            <div class="control-group">
                <h3>🔧 Motor Kontrolü</h3>
                <button class="btn-success" onclick="startHydraulicMotor()">Hidrolik Motor Başlat</button>
                <button class="btn-warning" onclick="stopHydraulicMotor()">Hidrolik Motor Durdur</button>
            </div>

            <div class="control-group">
                <h3>🚨 Acil Durum</h3>
                <button class="btn-danger" onclick="emergencyStop()">ACİL DURDUR</button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>⚙️ Piston Kontrolü</h3>
                <select id="pistonType">
                    <option value="TopPiston">Top Piston</option>
                    <option value="BottomPiston">Bottom Piston</option>
                    <option value="LeftPiston">Left Piston</option>
                    <option value="RightPiston">Right Piston</option>
                </select>
                <br>
                <input type="number" id="voltage" min="-10" max="10" step="0.1" value="0" placeholder="Voltaj (-10 ≤ V ≤ 10)">
                <br>
                <button class="btn-primary" onclick="movePiston()">Piston Hareket Ettir</button>
                <button class="btn-warning" onclick="stopPiston()">Piston Durdur</button>
            </div>
        </div>

        <h3>📱 Real-time Veriler</h3>
        <div id="realTimeData">
            <div id="machineStatusTable"></div>
            <div id="pistonStatusTable"></div>
        </div>

        <h3>📜 Mesaj Logları</h3>
        <div id="messages"></div>
    </div>

    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <script>
        let connection;
        let isConnected = false;

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDiv = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = '🟢 BAĞLANTI DURUMU: Bağlı - Real-time veri alınıyor';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '🔴 BAĞLANTI DURUMU: Bağlantı Kapalı';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function addMessage(message, type = 'info') {
            const messages = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `[${timestamp}] ${message}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateMachineStatusTable(status) {
            const container = document.getElementById('machineStatusTable');
            container.innerHTML = `
                <h4>🏭 Makine Durumu</h4>
                <table>
                    <tr><th>Özellik</th><th>Değer</th></tr>
                    <tr><td>Emergency Stop</td><td style="color: ${status.EmergencyStop ? 'red' : 'green'}">${status.EmergencyStop ? '⚠️ AKTIF' : '✅ NORMAL'}</td></tr>
                    <tr><td>Hidrolik Motor</td><td style="color: ${status.HydraulicMotorRunning ? 'green' : 'red'}">${status.HydraulicMotorRunning ? '✅ ÇALIŞIYOR' : '❌ DURMUŞ'}</td></tr>
                    <tr><td>Fan Motor</td><td style="color: ${status.FanMotorRunning ? 'green' : 'red'}">${status.FanMotorRunning ? '✅ ÇALIŞIYOR' : '❌ DURMUŞ'}</td></tr>
                    <tr><td>S1 Vana</td><td>${status.S1ValveOpen ? '🟢 AÇIK' : '🔴 KAPALI'}</td></tr>
                    <tr><td>S2 Vana</td><td>${status.S2ValveOpen ? '🟢 AÇIK' : '🔴 KAPALI'}</td></tr>
                    <tr><td>S1 Yağ Basıncı</td><td>${status.S1OilPressure?.toFixed(1)} bar</td></tr>
                    <tr><td>S2 Yağ Basıncı</td><td>${status.S2OilPressure?.toFixed(1)} bar</td></tr>
                    <tr><td>Yağ Sıcaklığı</td><td>${status.OilTemperature?.toFixed(1)} °C</td></tr>
                    <tr><td>Sol Parça</td><td>${status.LeftPartPresent ? '✅ VAR' : '❌ YOK'}</td></tr>
                    <tr><td>Sağ Parça</td><td>${status.RightPartPresent ? '✅ VAR' : '❌ YOK'}</td></tr>
                </table>
            `;
        }

        function updatePistonStatusTable(pistons) {
            const container = document.getElementById('pistonStatusTable');
            let tableHTML = `
                <h4>⚙️ Piston Durumları</h4>
                <table>
                    <tr><th>Piston</th><th>Pozisyon (mm)</th><th>Voltaj (V)</th><th>Hareket</th><th>Durumu</th></tr>
            `;
            
            pistons.forEach(piston => {
                tableHTML += `
                    <tr>
                        <td>${piston.Name}</td>
                        <td>${piston.CurrentPosition?.toFixed(2) || '0.00'}</td>
                        <td>${piston.CurrentVoltage?.toFixed(1) || '0.0'}</td>
                        <td>${piston.Motion || 'Closed'}</td>
                        <td style="color: ${piston.IsMoving ? 'orange' : 'green'}">${piston.IsMoving ? '⚡ HAREKETLİ' : '✅ DURGUN'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</table>';
            container.innerHTML = tableHTML;
        }

        async function connect() {
            try {
                // Current page protocol ve host kullan (HTTPS/HTTP sorununu çözer)
                const currentProtocol = window.location.protocol;
                const currentHost = window.location.host;
                const signalRUrl = `${currentProtocol}//${currentHost}/machinestatus`;
                
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(signalRUrl, {
                        accessTokenFactory: () => null,
                        skipNegotiation: false,
                        transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.LongPolling
                    })
                    .withAutomaticReconnect([0, 2000, 10000, 30000])
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                // Event handlers
                connection.on("MachineStatusUpdate", (status) => {
                    addMessage("📊 Machine status güncellendi", "data");
                    updateMachineStatusTable(status);
                });

                connection.on("PistonStatusUpdate", (pistons) => {
                    addMessage("⚙️ Piston status güncellendi", "data");
                    updatePistonStatusTable(pistons);
                });

                connection.on("PistonMoved", (data) => {
                    addMessage(`⚙️ ${data.PistonType} hareket etti: ${data.Motion} (${data.CurrentPosition.toFixed(2)}mm)`, "success");
                });

                connection.on("AlarmRaised", (data) => {
                    addMessage(`🚨 ALARM: ${data.Message} (${data.Severity})`, "error");
                });

                connection.on("SafetyViolation", (data) => {
                    addMessage(`⚠️ GÜVENLİK İHLALİ: ${data.ViolationType}`, "error");
                });

                connection.on("MachineConnected", (data) => {
                    addMessage(`✅ Makine bağlandı: ${data.Message}`, "success");
                });

                connection.on("MachineDisconnected", (data) => {
                    addMessage(`❌ Makine bağlantısı kesildi: ${data.Message}`, "warning");
                });

                connection.on("Error", (message) => {
                    addMessage(`❌ HATA: ${message}`, "error");
                });

                connection.on("SystemMessage", (data) => {
                    addMessage(`💬 ${data.Message} (${data.Level})`, "info");
                });

                connection.on("PerformanceUpdate", (data) => {
                    addMessage(`📈 Performance: ${data.UpdateCount} updates, ${data.AverageDuration.toFixed(1)}ms avg`, "info");
                });

                // Connection events
                connection.onreconnecting(() => {
                    addMessage("🔄 Yeniden bağlanıyor...", "warning");
                    updateConnectionStatus(false);
                });

                connection.onreconnected(() => {
                    addMessage("✅ Yeniden bağlandı", "success");
                    updateConnectionStatus(true);
                });

                connection.onclose(() => {
                    addMessage("❌ Bağlantı kapatıldı", "error");
                    updateConnectionStatus(false);
                });

                await connection.start();
                addMessage("✅ SignalR bağlantısı kuruldu", "success");
                updateConnectionStatus(true);

            } catch (err) {
                addMessage(`❌ Bağlantı hatası: ${err}`, "error");
                updateConnectionStatus(false);
            }
        }

        async function disconnect() {
            if (connection) {
                await connection.stop();
                addMessage("🔌 Bağlantı kapatıldı", "info");
                updateConnectionStatus(false);
            }
        }

        async function requestMachineStatus() {
            if (!isConnected) return;
            try {
                await connection.invoke("RequestMachineStatus");
                addMessage("📊 Makine durumu istendi", "info");
            } catch (err) {
                addMessage(`❌ Hata: ${err}`, "error");
            }
        }

        async function requestPistonStatus() {
            if (!isConnected) return;
            try {
                await connection.invoke("RequestPistonStatus");
                addMessage("⚙️ Piston durumu istendi", "info");
            } catch (err) {
                addMessage(`❌ Hata: ${err}`, "error");
            }
        }

        async function movePiston() {
            if (!isConnected) return;
            const pistonType = document.getElementById('pistonType').value;
            const voltage = parseFloat(document.getElementById('voltage').value);
            
            try {
                await connection.invoke("MovePiston", pistonType, voltage);
                addMessage(`⚙️ ${pistonType} hareket komutu gönderildi: ${voltage}V`, "success");
            } catch (err) {
                addMessage(`❌ Piston hareket hatası: ${err}`, "error");
            }
        }

        async function stopPiston() {
            if (!isConnected) return;
            const pistonType = document.getElementById('pistonType').value;
            
            try {
                await connection.invoke("StopPiston", pistonType);
                addMessage(`⏹️ ${pistonType} durdur komutu gönderildi`, "warning");
            } catch (err) {
                addMessage(`❌ Piston durdur hatası: ${err}`, "error");
            }
        }

        async function emergencyStop() {
            if (!isConnected) return;
            if (confirm("ACİL DURDUR komutu gönderilsin mi?")) {
                try {
                    await connection.invoke("EmergencyStop");
                    addMessage("🚨 ACİL DURDUR komutu gönderildi", "error");
                } catch (err) {
                    addMessage(`❌ Acil durdur hatası: ${err}`, "error");
                }
            }
        }

        async function startHydraulicMotor() {
            if (!isConnected) return;
            try {
                await connection.invoke("StartHydraulicMotor");
                addMessage("🔧 Hidrolik motor başlatma komutu gönderildi", "success");
            } catch (err) {
                addMessage(`❌ Motor başlatma hatası: ${err}`, "error");
            }
        }

        async function stopHydraulicMotor() {
            if (!isConnected) return;
            try {
                await connection.invoke("StopHydraulicMotor");
                addMessage("⏹️ Hidrolik motor durdurma komutu gönderildi", "warning");
            } catch (err) {
                addMessage(`❌ Motor durdurma hatası: ${err}`, "error");
            }
        }

        // Initialize
        updateConnectionStatus(false);
        addMessage("🚀 Test client hazır. Bağlanmak için 'Bağlan' butonuna tıklayın.", "info");
    </script>
</body>
</html> 