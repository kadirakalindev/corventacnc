@page
@model BendingMachine.Web.Pages.AutoBendingModel
@{
    ViewData["Title"] = "Corventa Profil Büküm Simülasyonu";
}

<style>
    .bending-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .simulation-panel {
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .simulation-title {
        background: #007bff;
        color: white;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
    }
    
    .parameters-panel {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
    }
    
    .parameters-title {
        background: #2196f3;
        color: white;
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
    }
    
    .calculation-results {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .compression-panel {
        background: #fff3e0;
        border: 1px solid #ff9800;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .reset-panel {
        background: #f3e5f5;
        border: 1px solid #9c27b0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .auto-bending-panel {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
    }
    
    .section-title {
        color: white;
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
    }
    
    .compression-title { background: #ff9800; }
    .reset-title { background: #9c27b0; }
    .auto-title { background: #2196f3; }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }
    
    .form-control {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px 12px;
    }
    
    .btn-group-custom {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .canvas-container {
        border: 2px solid #ccc;
        border-radius: 8px;
        background: white;
        padding: 10px;
    }
    
    #bendingCanvas {
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        height: 400px;
    }
    
    .alert-info {
        background: #cff4fc;
        border: 1px solid #b8daff;
        color: #055160;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffecb5;
        color: #664d03;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .alert-sm {
        padding: 8px;
        font-size: 12px;
        margin-bottom: 10px;
    }
    
    .badge {
        display: inline-block;
        padding: 0.25em 0.4em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }
    
    .bg-secondary { background-color: #6c757d !important; color: white; }
    .bg-success { background-color: #198754 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: black; }
    .bg-danger { background-color: #dc3545 !important; color: white; }
    
    .progress {
        display: flex;
        height: 1rem;
        overflow: hidden;
        background-color: #e9ecef;
        border-radius: 0.25rem;
    }
    
    .progress-bar {
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        background-color: #007bff;
        transition: width 0.6s ease;
    }
    
    .progress-bar-striped {
        background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
        background-size: 1rem 1rem;
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @@keyframes progress-bar-stripes {
        0% { background-position-x: 1rem; }
    }
</style>

<div class="bending-container">
    <!-- Ana Başlık -->
    <h1 class="text-center mb-4" style="color: #333;">Corventa Profil Büküm Simülasyonu</h1>
    
    <!-- Makine Bağlantı Durumu -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <strong>Makine Durumu:</strong> 
                    <span id="machineConnectionStatus" class="badge bg-secondary ms-2">Kontrol Ediliyor...</span>
                </div>
                <div>
                    <button id="btnConnect" class="btn btn-success btn-sm me-2" onclick="connectMachine()">Bağlan</button>
                    <button id="btnDisconnect" class="btn btn-danger btn-sm" onclick="disconnectMachine()">Bağlantıyı Kes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Makine Durum Paneli -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <strong>Makine Durumu</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Hidrolik Motor:</strong>
                                <span id="motorStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Parça Sensörü:</strong>
                                <span id="partSensorStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Encoder:</strong>
                                <span id="encoderStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Basınç:</strong>
                                <span id="pressureStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Top Piston:</strong>
                                <span id="TopPistonStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Bottom Piston:</strong>
                                <span id="BottomPistonStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Left Piston:</strong>
                                <span id="LeftPistonStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                            <div class="mb-2">
                                <strong>Right Piston:</strong>
                                <span id="RightPistonStatus" class="badge bg-secondary">Bilinmiyor</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Sol Panel - Büküm Simülasyonu -->
        <div class="col-md-6">
            <div class="simulation-panel">
                <div class="simulation-title">Büküm Simülasyonu</div>
                
                <!-- Canvas Çizim Alanı -->
                <div class="canvas-container">
                    <canvas id="bendingCanvas" width="500" height="400"></canvas>
                </div>
                
                <!-- Son Hesaplama -->
                <div class="alert-info mt-3">
                    <strong>Son Hesaplama:</strong> <span id="lastCalculation">Hesaplama yapılmadı</span>
                </div>
                
                <!-- Görselleştirme Kayıtları -->
                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <strong>Görselleştirme Kayıtları:</strong>
                    <div id="visualizationLog" style="font-size: 12px; max-height: 100px; overflow-y: auto;">
                        Hesaplama bekleniyor...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sağ Panel - Büküm Parametreleri -->
        <div class="col-md-6">
            <div class="parameters-panel">
                <div class="parameters-title">Büküm Parametreleri</div>
                
                <!-- Top Çapları -->
                <div class="form-group">
                    <label class="form-label">Üst Top İç Çapı (mm):</label>
                    <input type="number" id="topBallDiameter" class="form-control" value="220" min="100" max="300">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alt Top İç Çapı (mm):</label>
                    <input type="number" id="bottomBallDiameter" class="form-control" value="220" min="100" max="300">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Yan Top İç Çapı (mm):</label>
                    <input type="number" id="sideBallDiameter" class="form-control" value="220" min="100" max="300">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Büküm Yarıçapı (mm):</label>
                    <input type="number" id="bendingRadius" class="form-control" value="500" min="100" max="2000">
                </div>
                
                <!-- Profil Boyutları -->
                <div class="form-group">
                    <label class="form-label">Yükseklik (mm):</label>
                    <input type="number" id="profileHeight" class="form-control" value="80" min="20" max="200">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Uzunluk (mm):</label>
                    <input type="number" id="profileLength" class="form-control" value="1960" min="500" max="6000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Et Kalınlığı (mm):</label>
                    <input type="number" id="profileThickness" class="form-control" value="2" min="0.5" max="10" step="0.1">
                </div>
                
                <!-- Geometri Parametreleri -->
                <div class="form-group">
                    <label class="form-label">Üçgen Genişliği (mm):</label>
                    <input type="number" id="triangleWidth" class="form-control" value="493" min="200" max="800">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Üçgen Açısı (°):</label>
                    <input type="number" id="triangleAngle" class="form-control" value="27" min="10" max="60">
                </div>
                
                <!-- Kademe Ayarları -->
                <div class="form-group">
                    <label class="form-label">Kademe Ayarları:</label>
                    <div class="btn-group-custom">
                        <button class="btn btn-outline-primary btn-sm" onclick="setStage(0)">Kademe 1 (0mm)</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="setStage(60)">Kademe 2 (60mm)</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="setStage(120)">Kademe 3 (120mm)</button>
                    </div>
                </div>
                
                <!-- İşlem Parametreleri -->
                <div class="form-group">
                    <label class="form-label">Adım Büyüklüğü (mm):</label>
                    <input type="number" id="stepSize" class="form-control" value="20" min="5" max="50">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hedef Basınç (bar):</label>
                    <input type="number" id="targetPressure" class="form-control" value="50" min="10" max="200">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Basınç Toleransı (±bar):</label>
                    <input type="number" id="pressureTolerance" class="form-control" value="5" min="1" max="20">
                </div>
                
                <!-- Hesaplama Butonu -->
                <div class="btn-group-custom">
                    <button id="btnCalculate" class="btn btn-success btn-lg" onclick="calculateBending()">
                        Hesaplama Sonuçları
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hesaplama Sonuçları -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="calculation-results">
                <h5 style="color: #4caf50; margin-bottom: 15px;">Hesaplama Sonuçları</h5>
                <div id="calculationResults">
                    <p class="text-muted">Parametreleri girin ve "Hesaplama Sonuçları" butonuna basın</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alt Paneller -->
    <div class="row">
        <!-- Parça Sıkıştırma -->
        <div class="col-md-4">
            <div class="compression-panel">
                <div class="section-title compression-title">Parça Sıkıştırma</div>
                
                <div class="form-group">
                    <label class="form-label">Hedef Basınç (bar):</label>
                    <input type="number" id="compressionPressure" class="form-control" value="50" min="10" max="200">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Basınç Toleransı (±bar):</label>
                    <input type="number" id="pressureTolerance" class="form-control" value="5" min="1" max="20">
                </div>
                
                <button id="btnCompressPart" class="btn btn-warning btn-block" onclick="compressPart()">
                    <i class="fas fa-compress-arrows-alt"></i> Parça Sıkıştır
                </button>
            </div>
        </div>
        
        <!-- Parça Sıfırlama -->
        <div class="col-md-4">
            <div class="reset-panel">
                <div class="section-title reset-title">Parça Sıfırlama</div>
                
                <div class="form-group">
                    <label class="form-label">Profil Sıfırlama Mesafesi (mm):</label>
                    <input type="number" id="resetDistance" class="form-control" value="670" min="100" max="1000">
                </div>
                
                <div class="form-group">
                    <label class="form-label small text-info">
                        <i class="fas fa-info-circle"></i> Hassas rotasyon kontrolü ile güvenli sıfırlama
                    </label>
                </div>
                
                <button id="btnResetPart" class="btn btn-secondary btn-block" onclick="resetPart()">
                    <i class="fas fa-undo-alt"></i> Parça Sıfırla
                </button>
                
                <!-- İlerleme Göstergesi -->
                <div id="resetProgressPanel" class="mt-3" style="display: none;">
                    <div class="small text-muted mb-1">Sıfırlama İlerlemesi:</div>
                    <div class="progress mb-2" style="height: 20px;">
                        <div id="resetProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div id="resetStatusText" class="small text-info"></div>
                </div>
            </div>
        </div>
        
        <!-- Cetvel Sıfırlama -->
        <div class="col-md-4">
            <div class="reset-panel">
                <div class="section-title reset-title">Cetvel Sıfırlama</div>
                
                <div class="alert alert-warning alert-sm">
                    <small><strong><i class="fas fa-exclamation-triangle"></i> Uyarı:</strong> Tüm pistonları hareket ettirir!</small>
                </div>
                
                <button id="btnResetRulers" class="btn btn-warning btn-block" onclick="openRulerResetDialog()">
                    <i class="fas fa-tools"></i> Cetvel Sıfırlama
                </button>
                
                <!-- Cetvel Durumu -->
                <div class="mt-3">
                    <div class="small text-muted mb-1">Cetvel Durumları:</div>
                    <div id="rulerStatusDisplay" class="small">
                        <div class="row">
                            <div class="col-6"><span id="rulerM13M16" class="badge bg-secondary">M13-M16</span></div>
                            <div class="col-6"><span id="rulerM17M20" class="badge bg-secondary">M17-M20</span></div>
                            <div class="col-6"><span id="rulerPneumatic" class="badge bg-secondary">Pnömatik</span></div>
                            <div class="col-6"><span id="rulerRotation" class="badge bg-secondary">Rotasyon</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Otomatik Büküm Bölümü -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="auto-bending-panel">
                <div class="section-title auto-title">Otomatik Büküm İşlemleri</div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Sol Hedef Pozisyonu (mm):</label>
                            <input type="number" id="leftTargetPosition" class="form-control" value="0" readonly>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Sağ Hedef Pozisyonu (mm):</label>
                            <input type="number" id="rightTargetPosition" class="form-control" value="0" readonly>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Basınç Hedefi (bar):</label>
                            <input type="number" id="bendingPressure" class="form-control" value="50" readonly>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Basınç Toleransı (±bar):</label>
                            <input type="number" id="bendingTolerance" class="form-control" value="5" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="btn-group-custom d-flex justify-content-center">
                            <button id="btnStartBending" class="btn btn-primary btn-lg me-2" onclick="startAutoBending()">
                                <i class="fas fa-play"></i> Otomatik Büküm Başlat
                            </button>
                            <button id="btnStopBending" class="btn btn-danger btn-lg" onclick="stopAutoBending()" disabled>
                                <i class="fas fa-stop"></i> Otomatik Büküm İptal
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Büküm İlerleme Durumu -->
                <div id="bendingProgressPanel" class="mt-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Büküm İlerlemesi:</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="bendingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">Mevcut Durum:</h6>
                            <div id="bendingStatusText" class="alert alert-info">Hazırlanıyor...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paso Test Bölümü -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="paso-test-panel" style="background: #f0f8ff; padding: 20px; border-radius: 8px; border: 2px solid #4a90e2;">
                <div class="section-title" style="color: #4a90e2; margin-bottom: 15px;">
                    <i class="fas fa-flask"></i> Paso Test - Sadece Büküm İşlemi
                </div>
                
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> Bilgi:</strong> 
                    Bu test sadece paso (büküm) işlemini yapar. Cetvel sıfırlama, stage ayarlama, parça sıkıştırma ve sıfırlama işlemlerini önceden yapmanız gerekir.
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Yan Top Hareket Mesafesi (mm):</label>
                            <input type="number" id="pasoSideBallDistance" class="form-control" value="40.85" step="0.01" min="1" max="200">
                            <small class="text-muted">Alt ana pistonların hareket mesafesi</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Profil Uzunluğu (mm):</label>
                            <input type="number" id="pasoProfileLength" class="form-control" value="670" min="100" max="10000">
                            <small class="text-muted">Rotasyon mesafesi için kullanılır</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Adım Büyüklüğü (mm):</label>
                            <input type="number" id="pasoStepSize" class="form-control" value="20" min="5" max="100">
                            <small class="text-muted">Her paso'daki hareket miktarı</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Tahliye Süresi (saniye):</label>
                            <input type="number" id="pasoEvacuationTime" class="form-control" value="10" min="0" max="60">
                            <small class="text-muted">Test sonrası tahliye süresi</small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="btn-group-custom d-flex justify-content-center">
                            <button id="btnStartPasoTest" class="btn btn-info btn-lg" onclick="startPasoTest()">
                                <i class="fas fa-flask"></i> Paso Test Başlat
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Paso Test İlerleme Durumu -->
                <div id="pasoTestProgressPanel" class="mt-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-info">Test İlerlemesi:</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="pasoTestProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">Test Durumu:</h6>
                            <div id="pasoTestStatusText" class="alert alert-info">Hazırlanıyor...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alt Kontrol Paneli -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                <h6 style="color: #4caf50;">Hesaplama</h6>
                <div class="btn-group-custom">
                    <button class="btn btn-info" onclick="calculateAll()">Otomatik Parça Yükleme</button>
                    <button class="btn btn-secondary" onclick="resetParameters()">Parametreleri Dışa Aktar</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                <h6 style="color: #ff9800;">Kademe Yönetimi</h6>
                <div class="btn-group-custom">
                    <button class="btn btn-warning" onclick="resetRulers()">Parametreleri Dışa Aktar</button>
                    <button class="btn btn-success" onclick="openRulerResetDialog()">Cetvel Sıfırlama</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script src="~/js/auto-bending.js"></script> 